# Bootstrap PXE appliance dnsmasq config
#
# Responsibilities:
# - DHCP only for the target mini-PC (MAC pinned)
# - TFTP serving UEFI iPXE binary
# - Chainload iPXE script over HTTP once iPXE is running
#
# Notes:
# - This VM is assumed to have a static IP (var.vm_ip) on the isolated link.
# - Replace minipc MAC/IP via Packer template vars.

# Listen/bind only on the isolated interface.
interface=${BOOTSTRAP_IFACE}
bind-interfaces
listen-address=${VM_IP}

# Provide DNS to the Talos node so it can pull images from registries.
# We bind only to the isolated interface, so this DNS server is not exposed on any uplink.
# Upstream resolvers are taken from /etc/resolv.conf (typically populated by the uplink NIC's DHCP).
#
# Note: On Ubuntu, /etc/resolv.conf can point at systemd-resolved's stub (127.0.0.53), which is not
# a good upstream for dnsmasq inside this appliance. Use explicit upstreams for determinism.
domain-needed
bogus-priv
no-resolv
server=1.1.1.1
server=8.8.8.8
log-dhcp

# DHCP settings
dhcp-authoritative

# Target mini-PC only:
# - the dhcp-host line sets the tag "minipc"
# - dhcp-ignore ignores all clients that do not have that tag
dhcp-host=${MINIPC_MAC},set:minipc,${MINIPC_IP}
dhcp-ignore=tag:!minipc

# Provide a small pool (unused for non-target clients due to dhcp-ignore)
dhcp-range=${DHCP_RANGE},12h

# Ensure the Talos node has a default route + DNS for outbound pulls.
# The bootstrap appliance will NAT this traffic out via its uplink NIC.
dhcp-option=tag:minipc,option:router,${VM_IP}
dhcp-option=tag:minipc,option:dns-server,${VM_IP}

# TFTP settings
enable-tftp
tftp-root=/srv/tftp

# Detect iPXE (user-class) and UEFI x86_64 (client-arch 7)
dhcp-userclass=set:ipxe,iPXE
dhcp-match=set:efi64,option:client-arch,7

# Boot flow:
# - If client is already iPXE: hand it an HTTP script
# - Else if UEFI x86_64: hand it the iPXE UEFI binary via TFTP
#
# dnsmasq uses the *last* matching dhcp-boot entry, so keep the iPXE rule last
# (PXE clients often match both efi64 and ipxe after chainloading iPXE).
dhcp-boot=tag:efi64,ipxe.efi
dhcp-boot=tag:ipxe,${BOOTSTRAP_HTTP}/boot.ipxe



name: Build VyOS Image

on:
  push:
    branches: [master]
    paths:
      - 'infrastructure/network/vyos/**'
  pull_request:
    paths:
      - 'infrastructure/network/vyos/**'
  workflow_dispatch:
    inputs:
      upload:
        description: 'Upload image to e2 storage'
        type: boolean
        default: true

concurrency:
  group: vyos-build-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate flavor template
        run: |
          # Check that the template file exists and contains required placeholders
          TEMPLATE="infrastructure/network/vyos/vyos-build/build-flavors/gateway.toml"

          if [[ ! -f "${TEMPLATE}" ]]; then
            echo "ERROR: Template file not found: ${TEMPLATE}"
            exit 1
          fi

          if ! grep -q '%%SSH_KEY_TYPE%%' "${TEMPLATE}"; then
            echo "ERROR: Template missing %%SSH_KEY_TYPE%% placeholder"
            exit 1
          fi

          if ! grep -q '%%SSH_PUBLIC_KEY%%' "${TEMPLATE}"; then
            echo "ERROR: Template missing %%SSH_PUBLIC_KEY%% placeholder"
            exit 1
          fi

          echo "Template validation passed"

      - name: Check scripts are executable
        run: |
          for script in infrastructure/network/vyos/vyos-build/scripts/*.sh; do
            if [[ ! -x "${script}" ]]; then
              echo "ERROR: Script not executable: ${script}"
              exit 1
            fi
            echo "OK: ${script}"
          done

  build:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: warp-ubuntu-latest-x64-8x
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: tools/labctl/go.sum

      - name: Build labctl
        run: |
          cd tools/labctl
          go build -o ../../labctl .

      - name: Install SOPS
        run: |
          curl -LO https://github.com/getsops/sops/releases/download/v3.9.2/sops-v3.9.2.linux.amd64
          chmod +x sops-v3.9.2.linux.amd64
          sudo mv sops-v3.9.2.linux.amd64 /usr/local/bin/sops

      - name: Write SOPS age key
        run: |
          echo "${{ secrets.SOPS_AGE_KEY }}" > /tmp/age-key.txt
          chmod 600 /tmp/age-key.txt

      - name: Extract SSH public key
        env:
          SOPS_AGE_KEY_FILE: /tmp/age-key.txt
        run: |
          sops --decrypt \
            --extract '["ssh_public_key"]' images/packer-ssh.sops.yaml > /tmp/ssh_key.pub
          echo "SSH key extracted"

      - name: Clone vyos-build
        run: |
          git clone -b current --single-branch --depth 1 \
            https://github.com/vyos/vyos-build.git /tmp/vyos-build

      - name: Generate build flavor
        run: |
          ./infrastructure/network/vyos/vyos-build/scripts/generate-flavor.sh \
            "$(cat /tmp/ssh_key.pub)" \
            /tmp/vyos-build/data/build-flavors/gateway.toml

      - name: Build VyOS image
        run: |
          # Generate version string
          VERSION="lab-$(date +%Y%m%d%H%M%S)"

          docker run --rm --privileged \
            -v /tmp/vyos-build:/vyos \
            -v /dev:/dev \
            -e VYOS_BUILD_BY="ci@lab.gilman.io" \
            -w /vyos \
            vyos/vyos-build:current \
            bash -c "sudo ./build-vyos-image --architecture amd64 --build-by ci@lab.gilman.io --build-type release --version ${VERSION} gateway"

          # Find and move the output image (suppress permission denied errors)
          echo "Looking for .raw image in build output..."
          ls -la /tmp/vyos-build/ || true

          # The raw image is created in the vyos-build root directory
          RAW_FILE=$(find /tmp/vyos-build -maxdepth 1 -name "*.raw" -type f 2>/dev/null | head -1)

          if [[ -z "${RAW_FILE}" ]]; then
            echo "No .raw file in root, checking build directory..."
            RAW_FILE=$(find /tmp/vyos-build/build -name "*.raw" -type f 2>/dev/null | head -1)
          fi

          if [[ -z "${RAW_FILE}" || ! -f "${RAW_FILE}" ]]; then
            echo "ERROR: Build failed - no raw image found"
            echo "Contents of /tmp/vyos-build:"
            ls -la /tmp/vyos-build/ || true
            echo "Contents of /tmp/vyos-build/build:"
            ls -la /tmp/vyos-build/build/ 2>/dev/null || true
            exit 1
          fi

          echo "Found raw image: ${RAW_FILE}"
          cp "${RAW_FILE}" /tmp/vyos-gateway.raw
          echo "Build complete: /tmp/vyos-gateway.raw"
          ls -lah /tmp/vyos-gateway.raw

      - name: Upload to e2
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.upload)
        run: |
          ./labctl images upload \
            --credentials images/e2.sops.yaml \
            --sops-age-key-file /tmp/age-key.txt \
            --source /tmp/vyos-gateway.raw \
            --destination vyos/vyos-gateway.raw

      - name: Upload build artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vyos-gateway-image
          path: /tmp/vyos-gateway.raw
          retention-days: 7
          if-no-files-found: warn

  # Build container image for integration testing
  build-container:
    if: github.event_name == 'pull_request'
    runs-on: warp-ubuntu-latest-x64-8x
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Cache SOPS
        uses: actions/cache@v4
        with:
          path: ~/.cache/sops
          key: sops-v3.9.2

      - name: Install SOPS
        run: |
          if [[ -x "${HOME}/.cache/sops/sops" ]]; then
            sudo cp "${HOME}/.cache/sops/sops" /usr/local/bin/sops
            exit 0
          fi
          mkdir -p "${HOME}/.cache/sops"
          curl -Lo "${HOME}/.cache/sops/sops" \
            https://github.com/getsops/sops/releases/download/v3.9.2/sops-v3.9.2.linux.amd64
          chmod +x "${HOME}/.cache/sops/sops"
          sudo cp "${HOME}/.cache/sops/sops" /usr/local/bin/sops

      - name: Write SOPS age key
        run: |
          echo "${{ secrets.SOPS_AGE_KEY }}" > /tmp/age-key.txt
          chmod 600 /tmp/age-key.txt

      - name: Extract SSH public key
        env:
          SOPS_AGE_KEY_FILE: /tmp/age-key.txt
        run: |
          sops --decrypt \
            --extract '["ssh_public_key"]' images/packer-ssh.sops.yaml > /tmp/ssh_key.pub
          echo "SSH key extracted"

      - name: Clone vyos-build
        run: |
          git clone -b current --single-branch --depth 1 \
            https://github.com/vyos/vyos-build.git /tmp/vyos-build

      - name: Generate build flavor
        run: |
          ./infrastructure/network/vyos/vyos-build/scripts/generate-flavor.sh \
            "$(cat /tmp/ssh_key.pub)" \
            /tmp/vyos-build/data/build-flavors/gateway.toml

      - name: Build VyOS ISO
        run: |
          # Generate version string
          VERSION="test-$(date +%Y%m%d%H%M%S)"

          # Build ISO (produces squashfs we need for container)
          docker run --rm --privileged \
            -v /tmp/vyos-build:/vyos \
            -e VYOS_BUILD_BY="ci@lab.gilman.io" \
            -w /vyos \
            vyos/vyos-build:current \
            bash -c "sudo ./build-vyos-image --architecture amd64 --build-by ci@lab.gilman.io --build-type release --version ${VERSION} gateway"

          echo "Build complete, checking for squashfs..."
          find /tmp/vyos-build -name "*.squashfs" -type f 2>/dev/null || true

      - name: Install squashfs tools
        run: sudo apt-get update && sudo apt-get install -y squashfs-tools-ng

      - name: Build container image
        run: |
          cd /tmp/vyos-build

          # Find the squashfs filesystem
          SQUASHFS=$(find . -name "filesystem.squashfs" -type f 2>/dev/null | head -1)

          if [[ -z "${SQUASHFS}" ]]; then
            # Try alternative location
            SQUASHFS=$(find . -name "*.squashfs" -type f 2>/dev/null | head -1)
          fi

          if [[ -z "${SQUASHFS}" || ! -f "${SQUASHFS}" ]]; then
            echo "ERROR: squashfs not found"
            find . -type f -name "*.squashfs" 2>/dev/null || true
            ls -la build/ 2>/dev/null || true
            exit 1
          fi

          echo "Found squashfs: ${SQUASHFS}"

          # Extract squashfs to tarball
          sqfs2tar "${SQUASHFS}" > /tmp/rootfs.tar
          echo "Extracted rootfs.tar: $(ls -lah /tmp/rootfs.tar)"

          # Build container image
          cd $GITHUB_WORKSPACE
          cp /tmp/rootfs.tar .
          docker build -t vyos-gateway:test -f infrastructure/network/vyos/Dockerfile.containerlab .
          rm rootfs.tar

          echo "Container image built successfully"
          docker images vyos-gateway:test

      - name: Save container image
        run: |
          docker save vyos-gateway:test -o /tmp/vyos-gateway-container.tar
          ls -lah /tmp/vyos-gateway-container.tar

      - name: Upload container image artifact
        uses: actions/upload-artifact@v4
        with:
          name: vyos-container-image
          path: /tmp/vyos-gateway-container.tar
          retention-days: 1

  # Run integration tests using Containerlab
  integration-test:
    needs: build-container
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download container image artifact
        uses: actions/download-artifact@v4
        with:
          name: vyos-container-image
          path: /tmp

      - name: Load container image
        run: |
          docker load -i /tmp/vyos-gateway-container.tar
          docker images vyos-gateway:test

      - name: Install Containerlab
        run: |
          if [[ -x "${HOME}/.cache/containerlab/containerlab" ]]; then
            sudo cp "${HOME}/.cache/containerlab/containerlab" /usr/local/bin/containerlab
          else
            mkdir -p "${HOME}/.cache/containerlab"
            bash -c "$(curl -sL https://get.containerlab.dev)"
            BIN_PATH="$(command -v containerlab)"
            sudo cp "${BIN_PATH}" "${HOME}/.cache/containerlab/containerlab"
          fi
          containerlab version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: infrastructure/network/vyos/tests/requirements.txt

      - name: Install test dependencies
        run: |
          pip install -r infrastructure/network/vyos/tests/requirements.txt

      - name: Generate test config.boot
        run: |
          ssh-keygen -t ed25519 -f /tmp/vyos-test-key -N "" -C "vyos-ci"
          chmod +x infrastructure/network/vyos/tests/render-config-boot.sh
          infrastructure/network/vyos/tests/render-config-boot.sh "$(cat /tmp/vyos-test-key.pub)"

      - name: Deploy Containerlab topology
        run: |
          cd infrastructure/network/vyos/tests
          sudo containerlab deploy -t topology.clab.yml --reconfigure
        timeout-minutes: 10

      - name: Wait for VyOS boot
        run: |
          echo "Waiting for VyOS to boot..."
          CONTAINER="clab-vyos-gateway-test-gateway"

          # Wait for container to be running
          for i in {1..30}; do
            if docker ps --filter "name=${CONTAINER}" --filter "status=running" | grep -q "${CONTAINER}"; then
              echo "Container is running"
              break
            fi
            echo "Waiting for container... ($i/30)"
            sleep 3
          done

          # Wait for systemd to be ready
          for i in {1..60}; do
            if docker exec "${CONTAINER}" systemctl is-system-running --quiet 2>/dev/null; then
              echo "VyOS systemd is running"
              break
            fi
            echo "Waiting for systemd... ($i/60)"
            sleep 5
          done

          # Additional settle time for all services
          echo "Waiting for services to stabilize..."
          sleep 30

          # Check VyOS status
          docker exec "${CONTAINER}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show version || true

      - name: Run integration tests
        run: |
          cd infrastructure/network/vyos/tests
          pytest -v --tb=short -x

      - name: Collect logs on failure
        if: failure()
        run: |
          CONTAINER="clab-vyos-gateway-test-gateway"
          echo "=== Container logs ==="
          docker logs "${CONTAINER}" 2>&1 | tail -100 || true
          echo "=== VyOS configuration ==="
          docker exec "${CONTAINER}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show configuration 2>&1 || true
          echo "=== Interfaces ==="
          docker exec "${CONTAINER}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show interfaces 2>&1 || true

      - name: Cleanup
        if: always()
        run: |
          cd infrastructure/network/vyos/tests
          sudo containerlab destroy -t topology.clab.yml --cleanup || true

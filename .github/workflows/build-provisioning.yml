name: Build Provisioning Artifacts

on:
  push:
    #branches: [master]
    # paths:
    #   - '.github/workflows/build-provisioning.yml'
    #   - 'provisioning/*/index.yaml'
  workflow_dispatch:
    inputs:
      system:
        description: 'System to build (talos, vyos, etc.)'
        required: true
        type: string
      force:
        description: 'Force rebuild even if artifacts exist'
        type: boolean
        default: false

env:
  IDRIVE_BUCKET: provisioning
  IDRIVE_ENDPOINT: s3.us-west-1.idrivee2.com
  IDRIVE_REGION: us-west-1

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      systems: ${{ steps.changes.outputs.systems }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "systems=[\"${{ inputs.system }}\"]" >> $GITHUB_OUTPUT
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep 'provisioning/.*/index.yaml' | cut -d/ -f2 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
            if [ "$CHANGED" = "[]" ] || [ -z "$CHANGED" ]; then
              echo "No provisioning changes detected"
              echo "systems=[]" >> $GITHUB_OUTPUT
            else
              echo "Detected changes in: $CHANGED"
              echo "systems=${CHANGED}" >> $GITHUB_OUTPUT
            fi
          fi

  build:
    needs: detect-changes
    if: needs.detect-changes.outputs.systems != '[]'
    runs-on: warp-ubuntu-latest-x64-4x
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        system: ${{ fromJson(needs.detect-changes.outputs.systems) }}
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Read manifest
        id: manifest
        run: |
          MANIFEST="provisioning/${{ matrix.system }}/index.yaml"
          echo "versions=$(yq -o=json -I=0 '.versions' $MANIFEST)" >> $GITHUB_OUTPUT

      - name: Process versions
        env:
          IDRIVE_ACCESS_KEY: ${{ secrets.IDRIVE_ACCESS_KEY }}
          IDRIVE_SECRET_KEY: ${{ secrets.IDRIVE_SECRET_KEY }}
        run: |
          SYSTEM="${{ matrix.system }}"
          FORCE="${{ inputs.force || 'false' }}"

          for VERSION in $(echo '${{ steps.manifest.outputs.versions }}' | jq -r '.[]'); do
            echo ""
            echo "=========================================="
            echo "Processing ${SYSTEM} ${VERSION}"
            echo "=========================================="

            # Check if artifacts already exist (using AWS CLI which is pre-installed)
            if [ "$FORCE" != "true" ]; then
              export AWS_ACCESS_KEY_ID="${IDRIVE_ACCESS_KEY}"
              export AWS_SECRET_ACCESS_KEY="${IDRIVE_SECRET_KEY}"
              EXISTS=$(aws s3 ls "s3://${IDRIVE_BUCKET}/${SYSTEM}/${VERSION}/" \
                --endpoint-url "https://${IDRIVE_ENDPOINT}" \
                --region "${IDRIVE_REGION}" 2>/dev/null | wc -l || echo "0")
              if [ "$EXISTS" -gt 0 ]; then
                echo "Artifacts exist for ${VERSION}, skipping (use force=true to rebuild)"
                continue
              fi
            fi

            # Download ISO
            echo "Downloading ${SYSTEM} ${VERSION}..."
            ./scripts/download-iso.py "$SYSTEM" "$VERSION"

            # Upload artifacts
            echo "Uploading ${SYSTEM} ${VERSION}..."
            ./scripts/upload-artifacts.py "$SYSTEM" "$VERSION"

            echo "Completed ${SYSTEM} ${VERSION}"
          done

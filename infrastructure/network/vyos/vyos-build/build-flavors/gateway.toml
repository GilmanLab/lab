# VyOS Gateway Build Flavor
# Produces a raw disk image with lab configuration baked in
# Target: VP6630 (Minisforum) - Lab Gateway Router
#
# Usage:
#   This is a template file - use generate-flavor.sh to create the final TOML
#   with SSH credentials injected from SOPS secrets.

# Output format: raw disk image for Tinkerbell/NAS deployment
image_format = "raw"

# Image settings
disk_size = 8  # GB

# Include QEMU guest agent for VM environments
packages = ["qemu-guest-agent"]

# Boot settings - serial console for headless operation
[boot_settings]
console_type = "serial"
serial_console = "ttyS0,115200n8"

# Default configuration - will be merged with SSH key at build time
# This serves as the base config.boot content
#
# IMPORTANT: The SSH key placeholder %%SSH_KEY_TYPE%% and %%SSH_PUBLIC_KEY%%
# will be replaced by the build script with actual values from SOPS secrets.
#
# The configuration below is based on infrastructure/network/vyos/configs/gateway.conf
# converted to VyOS config.boot format (nested curly braces)
default_config = '''
firewall {
    group {
        network-group HOME_NETWORK {
            network 192.168.0.0/24
        }
        network-group LAB_NETWORKS {
            network 10.10.0.0/16
        }
        network-group RFC1918 {
            network 10.0.0.0/8
            network 172.16.0.0/12
            network 192.168.0.0/16
        }
    }
    interface eth4 {
        in {
            name WAN_TO_LAB
        }
        local {
            name LOCAL
        }
        out {
            name LAB_TO_WAN
        }
    }
    ipv4 {
        name LAB_TO_WAN {
            default-action accept
            rule 10 {
                action accept
                description "Allow established/related"
                state {
                    established
                    related
                }
            }
            rule 20 {
                action drop
                description "Block new connections to home network"
                destination {
                    group {
                        network-group HOME_NETWORK
                    }
                }
                state {
                    new
                }
            }
        }
        name LOCAL {
            default-action drop
            rule 10 {
                action accept
                state {
                    established
                    related
                }
            }
            rule 20 {
                action accept
                description "Allow ICMP"
                protocol icmp
            }
            rule 30 {
                action accept
                description "Allow SSH from lab"
                destination {
                    port 22
                }
                protocol tcp
                source {
                    group {
                        network-group LAB_NETWORKS
                    }
                }
            }
            rule 31 {
                action accept
                description "Allow SSH from home"
                destination {
                    port 22
                }
                protocol tcp
                source {
                    group {
                        network-group HOME_NETWORK
                    }
                }
            }
            rule 40 {
                action accept
                description "Allow DNS from lab"
                destination {
                    port 53
                }
                protocol udp
                source {
                    group {
                        network-group LAB_NETWORKS
                    }
                }
            }
            rule 50 {
                action accept
                description "Allow DHCP from lab"
                destination {
                    port 67
                }
                protocol udp
                source {
                    group {
                        network-group LAB_NETWORKS
                    }
                }
            }
            rule 60 {
                action accept
                description "Allow BGP from lab"
                destination {
                    port 179
                }
                protocol tcp
                source {
                    group {
                        network-group LAB_NETWORKS
                    }
                }
            }
        }
        name WAN_TO_LAB {
            default-action drop
            rule 10 {
                action accept
                description "Allow established/related"
                state {
                    established
                    related
                }
            }
            rule 20 {
                action accept
                description "Allow from home network"
                source {
                    group {
                        network-group HOME_NETWORK
                    }
                }
            }
        }
    }
}
interfaces {
    ethernet eth4 {
        address 192.168.0.2/24
        description "WAN - Transit to Home (CCR2004)"
    }
    ethernet eth5 {
        description "TRUNK - Lab Switch (CRS)"
        vif 10 {
            address 10.10.10.1/24
            description "LAB_MGMT - Infrastructure Management"
        }
        vif 20 {
            address 10.10.20.1/24
            description "LAB_PROV - Provisioning (PXE)"
        }
        vif 30 {
            address 10.10.30.1/24
            description "LAB_PLATFORM - Platform Cluster"
        }
        vif 40 {
            address 10.10.40.1/24
            description "LAB_CLUSTER - Tenant Clusters"
        }
        vif 50 {
            address 10.10.50.1/24
            description "LAB_SERVICE - Service VIPs (BGP)"
        }
        vif 60 {
            address 10.10.60.1/24
            description "LAB_STORAGE - Storage Replication"
        }
    }
}
nat {
    source {
        rule 100 {
            outbound-interface {
                name eth4
            }
            source {
                address 10.10.0.0/16
            }
            translation {
                address masquerade
            }
        }
    }
}
protocols {
    bgp {
        address-family {
            ipv4-unicast {
                network 10.10.50.0/24 {
                }
            }
        }
        neighbor 10.10.30.10 {
            address-family {
                ipv4-unicast {
                }
            }
            description "platform-cp-1 (UM760)"
            remote-as 64513
            shutdown
        }
        neighbor 10.10.30.11 {
            address-family {
                ipv4-unicast {
                }
            }
            description "platform-cp-2"
            remote-as 64513
            shutdown
        }
        neighbor 10.10.30.12 {
            address-family {
                ipv4-unicast {
                }
            }
            description "platform-cp-3"
            remote-as 64513
            shutdown
        }
        parameters {
            bestpath {
                as-path {
                    multipath-relax
                }
            }
            router-id 10.10.50.1
        }
        system-as 64512
    }
    static {
        route 0.0.0.0/0 {
            next-hop 192.168.0.1 {
            }
        }
    }
}
service {
    dhcp-relay {
        interface eth5.30
        interface eth5.40
        relay-options {
            relay-agents-packets discard
        }
        server 10.10.20.10
    }
    dhcp-server {
        shared-network-name LAB_MGMT {
            subnet 10.10.10.0/24 {
                lease 86400
                option {
                    default-router 10.10.10.1
                    name-server 10.10.10.1
                }
                range 0 {
                    start 10.10.10.200
                    stop 10.10.10.250
                }
                subnet-id 10
            }
        }
    }
    dns {
        forwarding {
            allow-from 10.10.0.0/16
            listen-address 10.10.10.1
            listen-address 10.10.20.1
            listen-address 10.10.30.1
            listen-address 10.10.40.1
            listen-address 10.10.50.1
            system
        }
    }
    ssh {
        disable-password-authentication
        port 22
    }
}
system {
    domain-name lab.gilman.io
    host-name gateway
    login {
        user vyos {
            authentication {
                public-keys admin {
                    key "%%SSH_PUBLIC_KEY%%"
                    type %%SSH_KEY_TYPE%%
                }
            }
        }
    }
    name-server 1.1.1.1
    name-server 8.8.8.8
    ntp {
        server time.cloudflare.com {
        }
    }
    time-zone America/Los_Angeles
}
'''

# VyOS Configuration Deployment Playbook
# Applies gateway.conf to VyOS with rollback protection
#
# Usage:
#   ansible-playbook deploy.yml -i ../inventory/hosts.yml
#   ansible-playbook deploy.yml -i ../inventory/hosts.yml -e "ssh_public_key_file=~/.ssh/id_rsa.pub"
#
# Environment Variables:
#   VYOS_HOST     - VyOS hostname or IP (default: gateway.lab.gilman.io)
#   VYOS_SSH_KEY  - Path to SSH private key for connection (default: ~/.ssh/id_rsa)
#
# Extra Variables:
#   ssh_public_key_file - Path to SSH public key to configure on VyOS (optional)
---
- name: Deploy VyOS Configuration
  hosts: vyos_gateway
  gather_facts: false

  vars:
    config_file: "{{ playbook_dir }}/../../configs/gateway.conf"
    backup_dir: "{{ playbook_dir }}/../../backups"
    commit_confirm_timeout: 5  # Minutes before auto-rollback
    ssh_public_key_file: ""  # Set via -e to configure SSH key

  tasks:
    - name: Ensure backup directory exists
      delegate_to: localhost
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        mode: "0755"

    - name: Get current configuration
      vyos.vyos.vyos_command:
        commands:
          - show configuration
      register: current_config

    - name: Backup current configuration
      delegate_to: localhost
      ansible.builtin.copy:
        content: "{{ current_config.stdout[0] }}"
        dest: "{{ backup_dir }}/gateway-{{ ansible_date_time.iso8601_basic_short }}.conf"
        mode: "0644"
      vars:
        ansible_date_time: "{{ lookup('pipe', 'date +%Y%m%dT%H%M%S') }}"

    - name: Read new configuration
      delegate_to: localhost
      ansible.builtin.slurp:
        src: "{{ config_file }}"
      register: new_config_raw

    - name: Load configuration with commit-confirm
      vyos.vyos.vyos_config:
        src: "{{ config_file }}"
        save: false  # Don't save yet - wait for confirm
        backup: true
      register: config_result
      vars:
        ansible_command_timeout: 120

    - name: Display configuration changes
      ansible.builtin.debug:
        msg: "{{ config_result }}"
      when: config_result.changed

    - name: Wait for connectivity test
      ansible.builtin.wait_for_connection:
        delay: 5
        timeout: 60
      when: config_result.changed

    - name: Confirm commit (prevents auto-rollback)
      vyos.vyos.vyos_command:
        commands:
          - confirm
      when: config_result.changed

    - name: Save configuration
      vyos.vyos.vyos_command:
        commands:
          - save
      when: config_result.changed

    # SSH Key Management (separate from main config)
    - name: Read SSH public key
      delegate_to: localhost
      ansible.builtin.slurp:
        src: "{{ ssh_public_key_file }}"
      register: ssh_key_content
      when: ssh_public_key_file | length > 0

    - name: Parse SSH key components
      ansible.builtin.set_fact:
        ssh_key_type: "{{ (ssh_key_content.content | b64decode).split()[0] }}"
        ssh_key_data: "{{ (ssh_key_content.content | b64decode).split()[1] }}"
      when: ssh_public_key_file | length > 0

    - name: Configure SSH public key
      vyos.vyos.vyos_config:
        lines:
          - "set system login user vyos authentication public-keys admin type {{ ssh_key_type }}"
          - "set system login user vyos authentication public-keys admin key {{ ssh_key_data }}"
        save: true
      when: ssh_public_key_file | length > 0
      register: ssh_key_result

    - name: Configuration deployment complete
      ansible.builtin.debug:
        msg: >
          VyOS configuration deployed successfully.
          Config changes: {{ 'Yes' if config_result.changed else 'No' }}
          SSH key configured: {{ 'Yes' if (ssh_key_result is defined and ssh_key_result.changed) else 'No' }}
